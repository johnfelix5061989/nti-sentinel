<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>NTI MONITOR - LIVE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #13293D;      /* Prussian Blue */
            --bg-surface: #006494;   /* Sapphire Blue */
            --accent-1: #247BA0;     /* Celadon Blue */
            --accent-bright: #1B98E0;/* Carolina Blue */
            --text-light: #E8F1F2;   /* Azure */
        }

        /* Ajuste no Body para o rodap√© ficar no ch√£o */
        body { 
            background-color: var(--bg-deep); 
            color: var(--text-light); 
            font-family: 'Segoe UI', sans-serif; 
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh; 
        }
        
        /* Cabe√ßalho */
        .header { 
            background: var(--bg-surface); 
            padding: 15px 30px; 
            border-bottom: 4px solid var(--accent-bright); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); 
        }
        .header h1 { margin: 0; font-weight: 700; letter-spacing: 2px; color: var(--text-light); }
        .header small { color: var(--accent-1); font-weight: bold; }
        
        /* Cards */
        .card-ticket { 
            background: var(--bg-surface); 
            border: none; 
            border-left: 6px solid var(--accent-bright); 
            margin-bottom: 20px; 
            transition: all 0.3s ease; 
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .card-ticket:hover { 
            transform: translateY(-5px); 
            background: var(--accent-1); 
            box-shadow: 0 8px 15px rgba(0,0,0,0.4);
        }
        .card-ticket h4 { font-weight: bold; color: var(--text-light); margin-top: 10px; }
        
        .ticket-meta { 
            font-size: 0.9rem; 
            color: #b0c4de;
            background: rgba(0,0,0,0.2);
            padding: 5px;
            border-radius: 5px;
        }

        /* Badge Setor */
        .badge-setor {
            background-color: var(--bg-deep);
            color: var(--accent-bright);
            border: 1px solid var(--accent-1);
        }
        
        /* Anima√ß√£o */
        .new-ticket { 
            animation: flashAlert 1.5s infinite alternate; 
            border-left-color: #ff6b6b; 
        }
        @keyframes flashAlert { 
            from { box-shadow: 0 0 5px var(--accent-bright); } 
            to { box-shadow: 0 0 20px var(--accent-bright); border-left-color: #ff4757; } 
        }

        /* Modal Escuro */
        .modal-content { 
            background: var(--bg-deep); 
            color: var(--text-light); 
            border: 2px solid var(--bg-surface); 
        }
        .modal-header { border-bottom: 1px solid var(--accent-1); background: var(--bg-surface); }
        .btn-close-white { filter: invert(1); }
        
        .form-control { 
            background: rgba(0,0,0,0.3); 
            border: 1px solid var(--accent-1); 
            color: white; 
        }
        .form-control:focus { background: rgba(0,0,0,0.5); color: white; border-color: var(--accent-bright); }

        /* Bot√µes do Modal */
        .btn-resolve { background: var(--accent-bright); color: var(--bg-deep); font-weight: bold; border: none; }
        .btn-resolve:hover { background: var(--text-light); }
        
        .btn-escalate { background: transparent; border: 2px solid #ff6b6b; color: #ff6b6b; font-weight: bold; }
        .btn-escalate:hover { background: #ff6b6b; color: var(--bg-deep); }

        /* RODAP√â */
        footer {
            margin-top: auto;
            text-align: center;
            padding: 15px;
            font-size: 0.8rem;
            color: var(--text-light);
            opacity: 0.4;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

    </style>
</head>
<body>

<div class="modal fade" id="modalLogin" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--bg-deep); border: 1px solid var(--accent-bright);">
            <div class="modal-header border-0 justify-content-center">
                <h3 style="color: white;">üõ°Ô∏è NTI Sentinel</h3>
            </div>
            <div class="modal-body text-center">
                <p class="text-light opacity-75">Acesso Restrito ao Operador</p>
                <input type="password" id="senhaInput" class="form-control text-center mb-3" placeholder="Senha..." style="font-size: 1.5rem;">
                <p id="erroSenha" class="text-danger fw-bold" style="display: none;">Senha incorreta!</p>
                <button class="btn btn-primary w-100 py-2" onclick="verificarSenha()" style="background: var(--accent-bright); font-weight: bold;">ACESSAR SISTEMA</button>
            </div>
        </div>
    </div>
</div>

<div id="app-content" style="filter: blur(10px); pointer-events: none; display: flex; flex-direction: column; min-height: 100vh;">

    <div class="header">
        <div>
            <h1>üì° NTI SENTINEL</h1>
            <small>MONITORAMENTO EM TEMPO REAL</small>
        </div>
        <div class="text-end">
            <h2 id="relogio" style="font-family: monospace; color: var(--accent-bright);">00:00:00</h2>
            <small style="opacity: 0.8">Reset Autom√°tico: 07:00 AM</small>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <div class="row" id="lista-chamados">
            </div>
        
        <div id="empty-state" class="text-center mt-5" style="display: none; color: var(--accent-1);">
            <h1 style="font-size: 5rem; opacity: 0.3;">üõ°Ô∏è</h1>
            <h3>Sistema Operante</h3>
            <p>Nenhum incidente na fila de atendimento.</p>
        </div>
    </div>

    <footer>
        Jo√£o Douglas Brito de S√° <strong>F√©lix</strong> 2026
    </footer>

</div>

<div class="modal fade" id="modalResolucao" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üë®‚Äçüíª Atender Chamado</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="ticketId">
                <div class="mb-3">
                    <label class="text-info mb-2">Descri√ß√£o da Solu√ß√£o / Parecer T√©cnico:</label>
                    <textarea id="solucaoTexto" class="form-control" rows="4" placeholder="Descreva o procedimento realizado..."></textarea>
                </div>
                <div class="row gap-2 px-2">
                    <button class="col btn btn-resolve py-3" onclick="resolver(true)">
                        ‚úÖ SOLUCIONADO (N1/N2)
                    </button>
                    <button class="col btn btn-escalate py-3" onclick="resolver(false)">
                        ‚ö†Ô∏è ESCALONAR P/ N3 (Infra)
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- L√ìGICA DE LOGIN ---
    const modalLogin = new bootstrap.Modal(document.getElementById('modalLogin'));

    // Verifica se j√° logou nesta sess√£o
    if(!sessionStorage.getItem('operador_logado')) {
        modalLogin.show();
    } else {
        desbloquearTela();
    }

    function verificarSenha() {
        const s = document.getElementById('senhaInput').value;
        if(s === "nti2026") { 
            sessionStorage.setItem('operador_logado', 'true');
            modalLogin.hide();
            desbloquearTela();
        } else {
            document.getElementById('erroSenha').style.display = 'block';
            document.getElementById('senhaInput').value = '';
        }
    }

    // Permite login com Enter
    document.getElementById('senhaInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') verificarSenha();
    });

    function desbloquearTela() {
        const app = document.getElementById('app-content');
        app.style.filter = 'none';
        app.style.pointerEvents = 'all';
        iniciarSistema(); // S√≥ conecta o socket e busca dados depois de logar
    }

    // --- SISTEMA DASHBOARD ---
    const socket = io();
    const lista = document.getElementById('lista-chamados');
    const emptyState = document.getElementById('empty-state');
    let modalInstance;

    function iniciarSistema() {
        // Rel√≥gio
        setInterval(() => {
            document.getElementById('relogio').innerText = new Date().toLocaleTimeString('pt-BR');
        }, 1000);

        // Busca inicial
        fetch('/api/tickets/ativos')
            .then(r => r.json())
            .then(tickets => {
                if(tickets.length === 0) emptyState.style.display = 'block';
                tickets.forEach(adicionarCard);
            });

        // Socket Events
        socket.on('novo_chamado', (ticket) => {
            emptyState.style.display = 'none';
            adicionarCard(ticket);
            const audio = new Audio('https://freesound.org/data/previews/250/250629_4486188-lq.mp3'); 
            audio.volume = 0.4;
            audio.play().catch(() => {});
        });

        socket.on('atualiza_chamado', (data) => {
            const card = document.getElementById(`card-${data.id}`);
            if(card) {
                card.style.transform = "scale(0.8)";
                card.style.opacity = "0";
                setTimeout(() => { 
                    card.remove(); 
                    if(lista.children.length === 0) emptyState.style.display = 'block';
                }, 300);
            }
        });

        socket.on('reset_diario', () => {
            lista.innerHTML = '';
            emptyState.style.display = 'block';
        });
    }

    function adicionarCard(t) {
        // Formata Matr√≠cula
        const matTexto = t.matricula ? `(Mat: ${t.matricula})` : '';
        
        const html = `
            <div class="col-md-4 col-lg-3 fade-in" id="card-${t.id}">
                <div class="card card-ticket p-3 new-ticket" onclick="abrirModal(${t.id})">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge" style="background: var(--bg-deep); color: var(--text-light)">#${t.id}</span>
                        <span class="badge badge-setor">${t.setor}</span>
                    </div>
                    <h4>${t.problema}</h4>
                    <hr style="border-color: var(--accent-1); opacity: 0.3;">
                    <div class="ticket-meta">
                        üë§ ${t.solicitante} <br> 
                        <small class="text-info">${matTexto}</small> <br>
                        üïí ${new Date(t.timestamp).toLocaleTimeString('pt-BR')}
                    </div>
                </div>
            </div>
        `;
        lista.insertAdjacentHTML('beforeend', html);
        setTimeout(() => {
            const el = document.getElementById(`card-${t.id}`);
            if(el) el.querySelector('.card-ticket').classList.remove('new-ticket');
        }, 15000);
    }

    function abrirModal(id) {
        document.getElementById('ticketId').value = id;
        modalInstance = new bootstrap.Modal(document.getElementById('modalResolucao'));
        modalInstance.show();
    }

    async function resolver(resolvido) {
        const id = document.getElementById('ticketId').value;
        const solucao = document.getElementById('solucaoTexto').value;
        const status = resolvido ? 'solucionado' : 'n3';

        if(!solucao) return alert("Por favor, descreva o que foi feito.");

        await fetch('/api/ticket/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id, status, solucao })
        });
        modalInstance.hide();
        document.getElementById('solucaoTexto').value = '';
    }
</script>
</body>
</html>